From cc3190968b1f14ddf4067abef849fc41bd6068dc Mon Sep 17 00:00:00 2001
From: Han Kang <hankang@google.com>
Date: Wed, 29 Jan 2020 12:25:55 -0800
Subject: [PATCH] remove client label from apiserver request count metric since
 it is unbounded

--- a/staging/src/k8s.io/apiserver/pkg/endpoints/metrics/BUILD	2020-04-09 01:21:01.342133055 +0530
+++ b/staging/src/k8s.io/apiserver/pkg/endpoints/metrics/BUILD	2020-04-09 01:22:01.686130916 +0530
@@ -3,13 +3,6 @@ package(default_visibility = ["//visibil
 load(
     "@io_bazel_rules_go//go:def.bzl",
     "go_library",
-    "go_test",
-)
-
-go_test(
-    name = "go_default_test",
-    srcs = ["metrics_test.go"],
-    embed = [":go_default_library"],
 )
 
 go_library(
--- a/staging/src/k8s.io/apiserver/pkg/endpoints/metrics/metrics.go	2020-04-09 02:05:01.506039479 +0530
+++ b/staging/src/k8s.io/apiserver/pkg/endpoints/metrics/metrics.go	2020-04-09 02:04:58.978039569 +0530
@@ -26,7 +26,6 @@ import (
 	"sync"
 	"time"
 
-	utilnet "k8s.io/apimachinery/pkg/util/net"
 	"k8s.io/apiserver/pkg/endpoints/request"
 
 	"github.com/emicklei/go-restful"
@@ -46,9 +45,9 @@ var (
 	requestCounter = prometheus.NewCounterVec(
 		prometheus.CounterOpts{
 			Name: "apiserver_request_count",
-			Help: "Counter of apiserver requests broken out for each verb, API resource, client, and HTTP response contentType and code.",
+			Help: "Counter of apiserver requests broken out for each verb, API resource, and HTTP response contentType and code.",
 		},
-		[]string{"verb", "resource", "subresource", "scope", "client", "contentType", "code"},
+		[]string{"verb", "resource", "subresource", "scope", "contentType", "code"},
 	)
 	longRunningRequestGauge = prometheus.NewGaugeVec(
 		prometheus.GaugeOpts{
@@ -192,9 +191,8 @@ func RecordLongRunning(req *http.Request
 // a request. verb must be uppercase to be backwards compatible with existing monitoring tooling.
 func MonitorRequest(req *http.Request, verb, resource, subresource, scope, contentType string, httpCode, respSize int, elapsed time.Duration) {
 	reportedVerb := cleanVerb(verb, req)
-	client := cleanUserAgent(utilnet.GetHTTPClient(req))
 	elapsedMicroseconds := float64(elapsed / time.Microsecond)
-	requestCounter.WithLabelValues(reportedVerb, resource, subresource, scope, client, contentType, codeToString(httpCode)).Inc()
+	requestCounter.WithLabelValues(reportedVerb, resource, subresource, scope, contentType, codeToString(httpCode)).Inc()
 	requestLatencies.WithLabelValues(reportedVerb, resource, subresource, scope).Observe(elapsedMicroseconds)
 	requestLatenciesSummary.WithLabelValues(reportedVerb, resource, subresource, scope).Observe(elapsedMicroseconds)
 	// We are only interested in response sizes of read requests.
@@ -282,16 +280,6 @@ func cleanVerb(verb string, request *htt
 	return reportedVerb
 }
 
-func cleanUserAgent(ua string) string {
-	// We collapse all "web browser"-type user agents into one "browser" to reduce metric cardinality.
-	if strings.HasPrefix(ua, "Mozilla/") {
-		return "Browser"
-	}
-	// If an old "kubectl.exe" has passed us its full path, we discard the path portion.
-	ua = kubectlExeRegexp.ReplaceAllString(ua, "$1")
-	return ua
-}
-
 // ResponseWriterDelegator interface wraps http.ResponseWriter to additionally record content-length, status-code, etc.
 type ResponseWriterDelegator struct {
 	http.ResponseWriter
--- a/staging/src/k8s.io/apiserver/pkg/endpoints/metrics/metrics_test.go	2020-04-09 01:21:26.330132169 +0530
+++ b/staging/src/k8s.io/apiserver/pkg/endpoints/metrics/metrics_test.go	1970-01-01 05:30:00.000000000 +0530
@@ -1,54 +0,0 @@
-/*
-Copyright 2015 The Kubernetes Authors.
-
-Licensed under the Apache License, Version 2.0 (the "License");
-you may not use this file except in compliance with the License.
-You may obtain a copy of the License at
-
-    http://www.apache.org/licenses/LICENSE-2.0
-
-Unless required by applicable law or agreed to in writing, software
-distributed under the License is distributed on an "AS IS" BASIS,
-WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-See the License for the specific language governing permissions and
-limitations under the License.
-*/
-
-package metrics
-
-import "testing"
-
-func TestCleanUserAgent(t *testing.T) {
-	panicBuf := []byte{198, 73, 129, 133, 90, 216, 104, 29, 13, 134, 209, 233, 30, 0, 22}
-
-	for _, tc := range []struct {
-		In  string
-		Out string
-	}{
-		{
-			In:  "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36",
-			Out: "Browser",
-		},
-		{
-			In:  "kubectl/v1.2.4",
-			Out: "kubectl/v1.2.4",
-		},
-		{
-			In:  `C:\Users\Kubernetes\kubectl.exe/v1.5.4`,
-			Out: "kubectl.exe/v1.5.4",
-		},
-		{
-			In:  `C:\Program Files\kubectl.exe/v1.5.4`,
-			Out: "kubectl.exe/v1.5.4",
-		},
-		{
-			// This malicious input courtesy of enisoc.
-			In:  string(panicBuf) + "kubectl.exe",
-			Out: "kubectl.exe",
-		},
-	} {
-		if cleanUserAgent(tc.In) != tc.Out {
-			t.Errorf("Failed to clean User-Agent: %s", tc.In)
-		}
-	}
-}
