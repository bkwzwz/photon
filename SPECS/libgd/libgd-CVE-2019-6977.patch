From 2e886046f86d0d6bfc14aab94a881259a081e3f4 Mon Sep 17 00:00:00 2001
From: wilson chen <willson.chenwx@gmail.com>
Date: Fri, 20 Dec 2019 10:12:04 +0800
Subject: [PATCH] Fix #497: gdImageColorMatch Out Of Bounds Write on Heap
 (CVE-2019-6977)

Fixed CVE-2019-6977 and add corresponding testcase.

Original patch by Christoph M. Bechker <cmbecker69@gmx.de>
https://gist.github.com/cmb69/1f36d285eb297ed326f5c821d7aafced
---
 src/gd_color_match.c                    |  5 ++---
 tests/gdimagecolormatch/CMakeLists.txt  |  1 +
 tests/gdimagecolormatch/Makemodule.am   |  1 +
 tests/gdimagecolormatch/cve_2019_6977.c | 25 +++++++++++++++++++++++++
 5 files changed, 30 insertions(+), 3 deletions(-)
 create mode 100644 tests/gdimagecolormatch/cve_2019_6977.c

diff --git a/src/gd_color_match.c b/src/gd_color_match.c
index f0842b69..f0194302 100644
--- a/src/gd_color_match.c
+++ b/src/gd_color_match.c
@@ -31,9 +31,8 @@ BGD_DECLARE(int) gdImageColorMatch (gdImagePtr im1, gdImagePtr im2)
 		return -4; /* At least 1 color must be allocated */
 	}
 
-	buf = (unsigned long *)gdMalloc(sizeof(unsigned long) * 5 * im2->colorsTotal);
-	memset (buf, 0, sizeof(unsigned long) * 5 * im2->colorsTotal );
-
+	buf = (unsigned long *)gdMalloc(sizeof(unsigned long) * 5 * gdMaxColors);
+	memset (buf, 0, sizeof(unsigned long) * 5 * gdMaxColors );
 	for (x=0; x < im1->sx; x++) {
 		for( y=0; y<im1->sy; y++ ) {
 			color = im2->pixels[y][x];
diff --git a/tests/gdimagecolormatch/CMakeLists.txt b/tests/gdimagecolormatch/CMakeLists.txt
index 6a191dc3..857b99a2 100644
--- a/tests/gdimagecolormatch/CMakeLists.txt
+++ b/tests/gdimagecolormatch/CMakeLists.txt
@@ -1,4 +1,5 @@
 LIST(APPEND TESTS_FILES
+	cve_2019_6977
 	gdimagecolormatch
 )
 
diff --git a/tests/gdimagecolormatch/Makemodule.am b/tests/gdimagecolormatch/Makemodule.am
index db6c3d49..4ed48cec 100644
--- a/tests/gdimagecolormatch/Makemodule.am
+++ b/tests/gdimagecolormatch/Makemodule.am
@@ -1,4 +1,5 @@
 libgd_test_programs += \
+	gdimagecolormatch/cve_2019_6977 \
 	gdimagecolormatch/gdimagecolormatch
 
 EXTRA_DIST += \
diff --git a/tests/gdimagecolormatch/cve_2019_6977.c b/tests/gdimagecolormatch/cve_2019_6977.c
new file mode 100644
index 00000000..fdd7af57
--- /dev/null
+++ b/tests/gdimagecolormatch/cve_2019_6977.c
@@ -0,0 +1,25 @@
+/**
+ * Test for CVE-2019-6977
+ */
+
+#include "gd.h"
+
+int main()
+{
+	gdImagePtr im1;
+	gdImagePtr im2;
+
+	im1 = gdImageCreateTrueColor(0xfff, 0xfff);
+	im2 = gdImageCreate(0xfff, 0xfff);
+	if (gdImageColorAllocate(im2, 0, 0, 0) < 0)
+	{
+		gdImageDestroy(im1);
+		gdImageDestroy(im2);
+		return 1;
+	}
+	gdImageSetPixel(im2, 0, 0, 255);
+	gdImageColorMatch(im1, im2);
+	gdImageDestroy(im1);
+	gdImageDestroy(im2);
+	return 0;
+}
