From b4bf47e826a5072bc737b5cd4affcc3cf1f435d9 Mon Sep 17 00:00:00 2001
From: Tapas Kundu <tkundu@vmware.com>
Date: Sun, 5 Apr 2020 15:55:49 +0800
Subject: [PATCH] bpo-39503: CVE-2020-8492: Fix AbstractBasicAuthHandler

The AbstractBasicAuthHandler class of the urllib.request module uses
an inefficient regular expression which can be exploited by an
attacker to cause a denial of service. Fix the regex to prevent the
catastrophic backtracking. Vulnerability reported by Ben Caller
and Matt Schwager.

Co-Authored-By: Serhiy Storchaka <storchaka@gmail.com>

Co-Authored-By: Victor Stinner <vstinner@python.org>

Signed-off-by: Tapas Kundu <tkundu@vmware.com>
---
 Lib/urllib2.py                                       | 12 +++++++++---
 .../2020-01-30-16-15-29.bpo-39503.B299Yq.rst         |  5 +++++
 2 files changed, 14 insertions(+), 3 deletions(-)
 create mode 100644 Misc/NEWS.d/next/Security/2020-01-30-16-15-29.bpo-39503.B299Yq.rst

diff --git a/Lib/urllib2.py b/Lib/urllib2.py
index 8b634ada3723b..106f7e3b05e25 100644
--- a/Lib/urllib2.py
+++ b/Lib/urllib2.py
@@ -856,9 +856,15 @@ class AbstractBasicAuthHandler:
 
     # allow for double- and single-quoted realm values
     # (single quotes are a violation of the RFC, but appear in the wild)
-    rx = re.compile('(?:.*,)*[ \t]*([^ \t]+)[ \t]+'
-                    'realm=(["\']?)([^"\']*)\\2', re.I)
-
+    rx = re.compile('(?:^|,)'   # start of the string or ','
+                    '[ \t]*'    # optional whitespaces
+                    '([^ \t]+)' # scheme like "Basic"
+                    '[ \t]+'    # mandatory whitespaces
+                    # realm=xxx
+                    # realm='xxx'
+                    # realm="xxx"
+                    'realm=(["\']?)([^"\']*)\\2',
+                    re.I)
     # XXX could pre-emptively send auth info already accepted (RFC 2617,
     # end of section 2, and section 1.2 immediately after "credentials"
     # production).
diff --git a/Misc/NEWS.d/next/Security/2020-01-30-16-15-29.bpo-39503.B299Yq.rst b/Misc/NEWS.d/next/Security/2020-01-30-16-15-29.bpo-39503.B299Yq.rst
new file mode 100644
index 0000000000000..9f2800581ca5e
--- /dev/null
+++ b/Misc/NEWS.d/next/Security/2020-01-30-16-15-29.bpo-39503.B299Yq.rst
@@ -0,0 +1,5 @@
+CVE-2020-8492: The :class:`~urllib.request.AbstractBasicAuthHandler` class of the
+:mod:`urllib.request` module uses an inefficient regular expression which can
+be exploited by an attacker to cause a denial of service. Fix the regex to
+prevent the catastrophic backtracking. Vulnerability reported by Ben Caller
+and Matt Schwager.
